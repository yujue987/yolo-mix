# YOLOv1, v2, v4, v7 实现修改记录

## 项目概述

基于 Ultralytics YOLO 框架实现 YOLOv1, YOLOv2, YOLOv4, 和 YOLOv7 模型，包含完整的模块实现、损失函数和训练配置。

---

# YOLOv1 实现修改记录

## 1. 文件：`ultralytics/nn/modules/block.py`

**修改内容：** 添加 Reshape 模块

**作用：** 用于将 YOLOv1 的展平特征重塑为 7x7x30 的输出格式

**行号：** 第 1919-1949 行

**具体代码：**

```python
class Reshape(nn.Module):
    def __init__(self, *args):
        super().__init__()
        self.shape = args

    def forward(self, x):
        return x.view(x.shape[0], *self.shape)
```

## 2. 文件：`ultralytics/nn/modules/head.py`

**修改内容：** 添加 YOLOv1Detect 检测头
**作用：** 实现 YOLOv1 原始检测头，支持 7x7 网格预测，每个网格预测 2 个边界框
**行号：** 第 627-699 行
**具体代码：**

```python
class YOLOv1Detect(nn.Module):
    def __init__(self, nc=80):
        super().__init__()
        self.nc = nc
        self.grid_size = 7
        self.num_boxes = 2
        self.stride = torch.tensor([32.0])
        self.reg_max = 1
        self.nl = 1

    def forward(self, x):
        if self.training:
            return x
        else:
            # ... 处理逻辑
            return x
```

## 3. 文件：`ultralytics/nn/modules/__init__.py`

**修改内容：** 添加模块导入
**作用：** 将新模块注册到框架中，使其可以在 YAML 配置中使用
**具体修改：**
- 在 `block` 模块导入列表末尾添加 `Reshape` 导入
- 在 `head` 模块导入列表末尾添加 `YOLOv1Detect` 导入
- 在 `__all__` 列表中添加 "YOLOv1Detect" 和 "Reshape"

## 4. 文件：`ultralytics/nn/tasks.py`

**修改内容：** 添加模块支持
**作用：** 支持 YOLOv1 模型的解析和损失函数选择，使框架能够正确识别和处理 YOLOv1 检测头
**具体修改：**
- 添加 `YOLOv1Detect` 导入
- 添加 `YOLOv1Loss` 导入
- 修改 `init_criterion` 方法添加 YOLOv1 支持
- 添加 `YOLOv1Detect` 特殊处理
- 在 `guess_model_task` 中添加 `YOLOv1Detect` 识别

## 5. 文件：`ultralytics/utils/loss.py`

**修改内容：** 添加 YOLOv1Loss 损失函数
**作用：** 实现 YOLOv1 原始论文中的损失函数
**行号：** 第 751-944 行
**具体代码：**

```python
class YOLOv1Loss:
    def __init__(self, model):
        # ... 初始化
        self.lambda_coord = 5.0
        self.lambda_noobj = 0.5
        self.mse = nn.MSELoss(reduction='sum')
        self.bce = nn.BCELoss(reduction='sum')

    def __call__(self, preds, batch):
        # ... Loss calculation logic
        return total_loss, loss_items.detach()
```

## 6. 文件：`ultralytics/cfg/models/v1-/yolov1.yaml`

**修改内容：** 修正全连接层维度
**作用：** 修正特征图维度计算错误，使其与实际网络输出匹配
**具体修改：**

```yaml
- [-1, 1, nn.Linear, [102400, 4096]]
```

## 文件修改总结

| 文件                             | 修改类型 | 主要内容                  | 行号范围    |
| -------------------------------- | -------- | ------------------------- | ----------- |
| `ultralytics/nn/modules/block.py` | 新增     | Reshape 模块              | 1919-1949   |
| `ultralytics/nn/modules/head.py` | 新增     | YOLOv1Detect 检测头       | 627-699     |
| `ultralytics/nn/modules/__init__.py` | 修改     | 模块导入                  | -           |
| `ultralytics/nn/tasks.py`        | 修改     | 模块支持                  | -           |
| `ultralytics/utils/loss.py`      | 新增     | YOLOv1Loss 损失函数       | 751-944     |
| `ultralytics/cfg/models/v1-/yolov1.yaml` | 修改     | 模型配置修正              | -           |

---

# YOLOv2 实现修改记录

## 1. 文件：`ultralytics/nn/modules/block.py`

**修改内容：** 新增 Passthrough 模块
**作用：** 将高分辨率细节信息融合到低分辨率语义特征中，提高检测精度
**行号：** 第 1950-2007 行
**具体代码：**

```python
class Passthrough(nn.Module):
    def forward(self, x):
        # ... 重排逻辑
        return x.view(x.shape[0], x.shape[1] * 4, x.shape[2] // 2, x.shape[3] // 2)
```

## 2. 文件：`ultralytics/nn/modules/head.py`

**修改内容：** 新增 YOLOv2Detect 检测头
**作用：** 基于 anchor boxes 进行目标检测，输出格式为(batch, anchors, height, width, 5+classes)
**行号：** 第 704-827 行
**具体代码：**

```python
class YOLOv2Detect(nn.Module):
    def __init__(self, anchors=None, nc=80):
        super().__init__()
        self.nc = nc
        self.na = len(anchors or [[1.3221, 1.73145], ...])
        # ... anchor_grid

    def forward(self, x):
        # ... 处理逻辑
        return x.permute(0, 3, 1, 2, 4).contiguous()
```

## 3. 文件：`ultralytics/utils/loss.py`

**修改内容：** 新增 YOLOv2Loss 损失函数
**作用：** 支持 YOLOv2 训练，权重配置：坐标损失 5.0，无目标损失 0.5，分类损失 1.0
**行号：** 第 946-1116 行
**具体代码：**

```python
class YOLOv2Loss:
    def __init__(self, model):
        # ... 初始化
        self.lambda_coord = 5.0
        self.lambda_noobj = 0.5
        self.lambda_class = 1.0

    def __call__(self, preds, batch):
        # ... loss calculation
        return coord_loss + conf_loss + class_loss
```

## 4. 文件：`ultralytics/nn/modules/__init__.py`

**修改内容：** 模块导入注册
**作用：** 将新模块注册到框架中，使其可以在 YAML 配置中使用
**具体修改：**
- 在 `block` 导入中添加 `Passthrough`
- 在 `head` 导入中添加 `YOLOv2Detect`
- 在 `__all__` 列表中添加 "YOLOv2Detect" 和 "Passthrough"

## 5. 文件：`ultralytics/nn/tasks.py`

**修改内容：** 框架集成支持
**作用：** 支持 YOLOv2 模型的解析和损失函数选择
**具体修改：**
- 添加 `Passthrough`, `YOLOv2Detect`, `YOLOv2Loss` 导入
- 在 `init_criterion` 方法中添加对 `YOLOv2Detect` 的支持
- 添加 `Passthrough` 通道数计算的特殊处理

## 6. 文件：`ultralytics/cfg/models/v2-/yolov2.yaml`

**修改内容：** 模型配置修正
**作用：** 简化配置以确保兼容性
**具体修改：**
- `nn.MaxPool` → `nn.MaxPool2d`
- 简化通道配置，移除复杂表达式

## 文件修改总结

| 文件                                     | 修改类型 | 主要内容                      | 行号范围    |
| ---------------------------------------- | -------- | ----------------------------- | ----------- |
| `ultralytics/nn/modules/block.py`        | 新增     | Passthrough 模块              | 1950-2007   |
| `ultralytics/nn/modules/head.py`         | 新增     | YOLOv2Detect 检测头           | 704-827     |
| `ultralytics/utils/loss.py`              | 新增     | YOLOv2Loss 损失函数           | 946-1116    |
| `ultralytics/nn/modules/__init__.py`     | 修改     | 模块导入注册                  | -           |
| `ultralytics/nn/tasks.py`                | 修改     | 框架集成支持                  | -           |
| `ultralytics/cfg/models/v2-/yolov2.yaml` | 修改     | 模型配置修正                  | -           |

---

#  YOLOv4 完整修复记录

## 1. 文件：`ultralytics/utils/loss.py`

**修改内容：** 新增 YOLOv4Loss 类
**作用：** 为 YOLOv4 提供专用的损失函数，解决 anchor-based 检测与现代 loss 函数的兼容性问题
**行号：** 第 930-1031 行
**具体修改：**

```python
class YOLOv4Loss:
    def __init__(self, model):
        # ... 初始化
        self.bce = nn.BCEWithLogitsLoss(reduction='none')
        self.mse = nn.MSELoss(reduction='none')

    def __call__(self, preds, batch):
        # ... loss calculation
        return total_loss, loss_items.detach()
```

### 2. 文件：`ultralytics/nn/tasks.py`

**修改内容：** 更新 imports 和 init_criterion 方法
**作用：** 导入 YOLOv4Loss 并在 DetectionModel 中正确初始化
**行号：**
- 第 69 行：添加 YOLOv4Loss 导入
- 第 411-413 行：添加 YOLOv4Detect 判断逻辑

### 3. 文件：`ultralytics/nn/modules/head.py`

**修改内容：** 优化 YOLOv4Detect 的 forward 方法
**作用：** 修正输出格式，确保与损失函数的兼容性
**行号：** 第 927-970 行
**具体修改：**

```python
def forward(self, x):
    if self.training:
        return [conv(x_i) for conv, x_i in zip(self.cv3, x)]
    else:
        # ... inference
        return torch.cat(z, 1) if len(z) > 1 else z[0]
```

### 4. 文件：`ultralytics/utils/metrics.py`

**修改内容：** 修复混淆矩阵索引越界问题
**作用：** 解决验证阶段出现的 `IndexError: index 21145 is out of bounds for axis 0 with size 81` 错误
**行号：** 第 371-382 行
**具体修改：**
- 添加边界检查，确保所有索引都在矩阵维度范围内
- 使用 `.item()` 方法安全提取 tensor 值

## 文件修改总结

| 文件                             | 修改类型 | 主要内容                  | 行号范围    |
| -------------------------------- | -------- | ------------------------- | ----------- |
| `ultralytics/utils/loss.py`      | 新增     | YOLOv4Loss 类             | 930-1031    |
| `ultralytics/nn/tasks.py`        | 修改     | 导入和判断逻辑            | 69, 411-413 |
| `ultralytics/nn/modules/head.py` | 修改     | YOLOv4Detect forward 方法 | 927-970     |
| `ultralytics/utils/metrics.py`   | 修复     | 混淆矩阵边界检查          | 371-382     |

---

#  YOLOv7 实现修改记录

## 1. 文件：`ultralytics/nn/modules/block.py`

**修改内容：** 新增 YOLOv7 核心模块实现
**作用：** 实现 YOLOv7 架构中的关键组件
**行号：** 第 2080-2297 行

**具体模块：**
- **ELAN 模块**: 控制最短和最长梯度路径
- **MPConv 模块**: 高效下采样模块
- **SPPCSPC 模块**: 结合空间金字塔池化和跨阶段部分连接

### 2. 文件：`ultralytics/nn/modules/head.py`

**修改内容：** 实现 YOLOv7 检测头
**作用：** 提供 YOLOv7 的主检测头和辅助检测头
**行号：** 第 1012-1251 行

**具体模块：**
- **YOLOv7Detect**: 主检测头，支持 anchor-based 检测
- **YOLOv7AuxDetect**: 辅助检测头，仅在训练时激活

### 3. 文件：`ultralytics/utils/loss.py`

**修改内容：** 实现 YOLOv7Loss 损失函数
**作用：** 为 YOLOv7 提供专用的损失计算
**行号：** 第 1157-1304 行
**关键特性：** 支持主检测头和辅助检测头的联合训练。

### 4. 文件：`ultralytics/nn/modules/__init__.py`

**修改内容：** 导出 YOLOv7 相关模块
**作用：** 使 YOLOv7 模块可以被正确导入和使用

### 5. 文件：`ultralytics/nn/tasks.py`

**修改内容：** 集成 YOLOv7 到框架解析器和损失初始化
**作用：** 使 YOLOv7 模块能够被正确解析和训练

### 6. 文件：`ultralytics/cfg/models/v7-/yolov7.yaml`

**修改内容：** 简化 YOLOv7 配置以确保兼容性
**作用：** 保持模型结构不变的同时，确保能够正确解析和训练

## 文件修改总结

| 文件                                     | 修改类型 | 主要内容                      |
| ---------------------------------------- | -------- | ----------------------------- |
| `ultralytics/nn/modules/block.py`        | 新增     | ELAN、MPConv、SPPCSPC 模块    |
| `ultralytics/nn/modules/head.py`         | 新增     | YOLOv7Detect、YOLOv7AuxDetect |
| `ultralytics/utils/loss.py`              | 新增     | YOLOv7Loss 损失函数           |
| `ultralytics/nn/modules/__init__.py`     | 修改     | 模块导入和导出                |
| `ultralytics/nn/tasks.py`                | 修改     | 解析器集成和损失初始化        |
| `ultralytics/cfg/models/v7-/yolov7.yaml` | 修改     | 简化检测头配置                |
